Subject: [PATCH] refactor: patch vulnerability fixes
---
Index: src/endstone/runtime/bedrock_hooks/certificate.cpp
===================================================================
diff --git a/src/endstone/runtime/bedrock_hooks/certificate.cpp b/src/endstone/runtime/bedrock_hooks/certificate.cpp
deleted file mode 100644
--- a/src/endstone/runtime/bedrock_hooks/certificate.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ /dev/null	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
@@ -1,37 +0,0 @@
-// Copyright (c) 2024, The Endstone Project. (https://endstone.dev) All Rights Reserved.
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//     http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-#include "bedrock/certificates/certificate.h"
-
-#include <nlohmann/json.hpp>
-
-#include "endstone/runtime/hook.h"
-
-UnverifiedCertificate UnverifiedCertificate::fromString(const std::string &input)
-{
-    if (input.size() <= 0x300000) {
-        try {
-            auto json = nlohmann::json::parse(input);
-            if (json.is_object()) {
-                auto &chain = json["chain"];
-                if (chain.is_array() && chain.size() <= 3) {
-                    return ENDSTONE_HOOK_CALL_ORIGINAL(&UnverifiedCertificate::fromString, input);
-                }
-            }
-        }
-        catch (...) {
-        }
-    }
-    return {WebToken(), nullptr};
-}
Index: src/endstone/runtime/bedrock_hooks/item.cpp
===================================================================
diff --git a/src/endstone/runtime/bedrock_hooks/item.cpp b/src/endstone/runtime/bedrock_hooks/item.cpp
deleted file mode 100644
--- a/src/endstone/runtime/bedrock_hooks/item.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ /dev/null	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
@@ -1,42 +0,0 @@
-// Copyright (c) 2024, The Endstone Project. (https://endstone.dev) All Rights Reserved.
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//     http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.
-
-#include "bedrock/world/item/item.h"
-
-#include "bedrock/util/string_byte_input.h"
-
-void Item::readUserData(ItemStackBase &stack, IDataInput &input, ReadOnlyBinaryStream &underlying_stream) const
-{
-    auto marker_result = input.readShortResult();
-    if (!marker_result.ignoreError()) {
-        return;
-    }
-    if (marker_result.discardError().value() == -1) {
-        auto version_result = input.readByteResult();
-        if (!version_result.ignoreError()) {
-            return;
-        }
-        if (version_result.discardError().value() != 1) {
-            return;
-        }
-        if (auto tags = NbtIo::readOrGetEmpty(input)) {
-            stack.setUserData(std::move(tags));
-        }
-    }
-    else if (marker_result.discardError().value() != 0) {
-        // legacy format?
-        return;
-    }
-    stack.deserializeComponents(input);
-}
Index: src/endstone/runtime/bedrock_hooks/server_network_handler.cpp
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/endstone/runtime/bedrock_hooks/server_network_handler.cpp b/src/endstone/runtime/bedrock_hooks/server_network_handler.cpp
--- a/src/endstone/runtime/bedrock_hooks/server_network_handler.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/endstone/runtime/bedrock_hooks/server_network_handler.cpp	(date 1763541585338)
@@ -54,15 +54,6 @@
 
     ENDSTONE_HOOK_CALL_ORIGINAL(&ServerNetworkHandler::disconnectClientWithMessage, this, id, sub_id, reason,
                                 disconnect_message, std::move(filtered_message), skip_message);
-
-    // BUGFIX:
-    // Forcibly mark the connection as disconnected immediately so no further packets from this client are accepted or
-    // processed. The original code sends a disconnection notification to the client, but a malicious client may ignore
-    // it and keep sending packets. The system still processes incoming packets afterward, which leaves the server
-    // vulnerable to continued packet spam.
-    if (auto *connection = network_._getConnectionFromId(id); connection) {
-        connection->disconnect();
-    }
 }
 
 bool ServerNetworkHandler::trytLoadPlayer(ServerPlayer &server_player, const ConnectionRequest &connection_request)
Index: src/endstone/runtime/bedrock_hooks/rak_peer_helper.cpp
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/endstone/runtime/bedrock_hooks/rak_peer_helper.cpp b/src/endstone/runtime/bedrock_hooks/rak_peer_helper.cpp
--- a/src/endstone/runtime/bedrock_hooks/rak_peer_helper.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/endstone/runtime/bedrock_hooks/rak_peer_helper.cpp	(date 1763541549022)
@@ -24,8 +24,6 @@
 {
     auto new_def = def;
     new_def.max_num_connections = SharedConstants::NetworkDefaultMaxConnections;
-    if (peer && purpose == PeerPurpose::Gameplay) {
-        peer->SetLimitIPConnectionFrequency(true);  // limit connections from the same ip in 100 milliseconds.
-    }
+
     return ENDSTONE_HOOK_CALL_ORIGINAL(&RakPeerHelper::peerStartup, this, peer, new_def, purpose);
 }
Index: src/endstone/core/server.cpp
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/endstone/core/server.cpp b/src/endstone/core/server.cpp
--- a/src/endstone/core/server.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/endstone/core/server.cpp	(date 1763541474874)
@@ -137,7 +137,6 @@
     loadResourcePacks();
     initRegistries();
     level._getPlayerDeathManager()->sender_.reset();                       // prevent BDS from sending the death message
-    (void)dispatchCommand(getCommandSender(), "reloadpacketlimitconfig");  // enable packet rate limiter
 
     // #blameMojang
     // MapItemSavedData never removes disconnected players from its
Index: src/bedrock/world/item/item.h
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/bedrock/world/item/item.h b/src/bedrock/world/item/item.h
--- a/src/bedrock/world/item/item.h	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/bedrock/world/item/item.h	(date 1763541940726)
@@ -139,8 +139,7 @@
     virtual Bedrock::Safety::RedactableString const buildRedactedDescriptionName(ItemStackBase const &) const = 0;
     virtual std::string buildDescriptionId(ItemDescriptor const &, CompoundTag const *) const = 0;
     virtual std::string buildEffectDescriptionName(ItemStackBase const &) const = 0;
-    ENDSTONE_HOOK virtual void readUserData(ItemStackBase &stack, IDataInput &input,
-                                            ReadOnlyBinaryStream &underlying_stream) const;
+    virtual void readUserData(ItemStackBase &stack, IDataInput &input, ReadOnlyBinaryStream &underlying_stream) const = 0;
     virtual void writeUserData(ItemStackBase const &, IDataOutput &) const = 0;
     virtual std::uint8_t getMaxStackSize(ItemDescriptor const &) const = 0;
     virtual bool inventoryTick(ItemStack &, Level &, Actor &, int, bool) const = 0;
Index: src/endstone/runtime/bedrock_hooks/network_connection.cpp
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/endstone/runtime/bedrock_hooks/network_connection.cpp b/src/endstone/runtime/bedrock_hooks/network_connection.cpp
--- a/src/endstone/runtime/bedrock_hooks/network_connection.cpp	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/endstone/runtime/bedrock_hooks/network_connection.cpp	(date 1763541518832)
@@ -29,10 +29,6 @@
     auto &network = server.getServer().getNetwork();
 
     while (true) {
-        if (disconnected_) {
-            return NetworkPeer::DataStatus::NoData;
-        }
-
         const auto status =
             ENDSTONE_HOOK_CALL_ORIGINAL(&NetworkConnection::receivePacket, this, receive_buffer, timepoint_ptr);
         if (status != NetworkPeer::DataStatus::HasData) {
Index: src/bedrock/certificates/certificate.h
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/bedrock/certificates/certificate.h b/src/bedrock/certificates/certificate.h
--- a/src/bedrock/certificates/certificate.h	(revision 96ee3a8d37421e697db0f30b31362c6e23822a12)
+++ b/src/bedrock/certificates/certificate.h	(date 1763541771036)
@@ -21,7 +21,6 @@
 
 class UnverifiedCertificate {
 public:
-    ENDSTONE_HOOK static UnverifiedCertificate fromString(const std::string &input);
     friend class Certificate;
 
 private:
